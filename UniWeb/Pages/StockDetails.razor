@page "/stockdetails/{id:int}"
@using UniWeb.Data.Models
@using UniWeb.Services
@using UniWebServer.Data.Models
@inject StockServices stockServices

<h1>@stock.Name</h1>
<p>@stock.Description</p>

@if (stock != null)
{
    <div style="margin-bottom: 20px;">
        <h3>@stock.Name</h3>
        @if (stock.AnalysisImageData != null)
        {
            <img src="data:@stock.AnalysisImageType;base64,@Convert.ToBase64String(stock.AnalysisImageData)" alt="Analysbild" style="width: 100%; max-height: 400px;" />
        }
        <p>@stock.Description</p>
    </div>
}
else
{
    <p>Laddar aktiedata...</p>
}

<!-- Historik -->
<h3>Historik</h3>
<ul class="history-list">
    @foreach (var history in stockHistory)
    {
        <li @onclick="() => LoadAnalysis(history)">
            <img src="@history.AnalysisImagePath" alt="Analysis" class="history-thumbnail" />
            <p>@history.UploadDate.ToShortDateString()</p>
        </li>
    }
</ul>

<!-- Modal för att förstora bilden -->
<Modal ImageSource="@ModalImageSource" IsBase64Image="@IsModalImageBase64" @ref="ImageModal" />

@code {
    [Parameter] public int id { get; set; }

    private Stock stock = new Stock();
    private List<StockHistory> stockHistory = new();
    private Modal ImageModal;
    private string? ModalImageSource;
    private bool IsModalImageBase64;

    protected override async Task OnInitializedAsync()
    {
        // Hämta aktieinformation och historik
        stock = stockServices.GetStockById(id);
        stockHistory = stockServices.GetStockHistoryByStockId(id);


        // Sätt modalbildens källa till huvudanalysen
        if (stock.AnalysisImageData != null)
        {
            ModalImageSource = $"data:{stock.AnalysisImageType};base64,{Convert.ToBase64String(stock.AnalysisImageData)}";
            IsModalImageBase64 = true;
        }
        else if (!string.IsNullOrEmpty(stock.AnalysisImageType))
        {
            ModalImageSource = stock.AnalysisImageType;
            IsModalImageBase64 = false;
        }
    }

    private void OpenModal()
    {
        // Visa modalen när användaren klickar på huvudbilden
        ImageModal?.Show();
    }

    private void LoadAnalysis(StockHistory history)
    {
        // Uppdatera sidan med vald analys
        stock.Description = history.Description;

        // Använd analysens filväg för modalen
        ModalImageSource = history.AnalysisImagePath;
        IsModalImageBase64 = false;
    }
}
